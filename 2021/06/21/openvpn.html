<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="https://robsware.github.io//assets/css/syntax.css"><link rel="preconnect" href="https://cdnjs.cloudflare.com"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><title> How to access your virtual machine from the internet with OpenVPN - robsware</title><link rel="shortcut icon" href="https://robsware.github.io//favicon.png"><link rel="alternate" type="application/atom+xml" title="robsware" href="https://robsware.github.io//atom.xml"><link rel="alternate" type="application/json" title="robsware" href="https://robsware.github.io//feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="https://robsware.github.io//sitemap.xml" /><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&family=Source+Code+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,300;1,400;1,500;1,600;1,700;1,900&display=swap" rel="stylesheet"><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}html{font-size:15px}#theme-toggle{opacity:0.65;position:relative;border-radius:5px;height:25px;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;transition:opacity 0.3s ease 0s;border:none;outline:none;background:none;cursor:pointer;padding:0px;appearance:none;transform:scale(0.8)}html,html[data-theme="light"]{--text-font: Play;--source-code-font: Source Code Pro;--very-light-text-color: rgb(222, 222, 222);--light-text-color: rgb(89, 183, 255);--medium-text-color: #555;--main-text-color: #333;--highlight-text-color: #6cb4a0;--dark-text-color: #393e46;--link-color: rgb(50, 87, 209);--code-bg-color: rgb(245, 245, 245);background-color:#fff}html #theme-toggle div,html[data-theme="light"] #theme-toggle div{position:relative;width:24px;height:24px;border-radius:50%;border:none;background-color:var(--theme-ui-colors-transparent, transparent);transform:scale(1);transition:all 0.45s ease 0s;overflow:hidden;box-shadow:inset 8px -8px 0px 0px var(--theme-ui-colors-toggleIcon, #2d3748)}html #theme-toggle div::before,html[data-theme="light"] #theme-toggle div::before{content:"";position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:none;border-radius:50%;transform:translate(0px, 0px);opacity:1;transition:transform 0.45s ease 0s}html #theme-toggle div::after,html[data-theme="light"] #theme-toggle div::after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0px 0px -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-toggleIcon, #2d3748),0 23px 0 var(--theme-ui-colors-toggleIcon, #2d3748),23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748),-23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748),15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),-15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),-15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748);transform:scale(0);transition:all 0.35s ease 0s}html[data-theme="dark"]{--text-font: Play;--source-code-font: Source Code Pro;--very-light-text-color: #EEE;--light-text-color: #c4bbf0;--medium-text-color: #52057b;--main-text-color: #EAEAEA;--highlight-text-color: #6cb4a0;--dark-text-color: rgb(36, 38, 42);--link-color: rgb(255, 89, 89);--code-bg-color: rgb(36, 38, 42);background-color:#131418}html[data-theme="dark"] #theme-toggle div{position:relative;width:24px;height:24px;border-radius:50%;border:4px solid var(--theme-ui-colors-toggleIcon, #cbd5e0);background-color:var(--theme-ui-colors-toggleIcon, #cbd5e0);transform:scale(0.55);transition:all 0.45s ease 0s;overflow:visible;box-shadow:none}html[data-theme="dark"] #theme-toggle div::before{content:"";position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:2px solid var(--theme-ui-colors-toggleIcon, #cbd5e0);border-radius:50%;transform:translate(14px, -14px);opacity:0;transition:transform 0.45s ease 0s}html[data-theme="dark"] #theme-toggle div::after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0px 0px -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),0 23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0);transform:scale(1);transition:all 0.35s ease 0s}body{font-family:var(--text-font),monospace;text-rendering:optimizeLegibility;line-height:1.75;color:var(--main-text-color)}a{color:var(--link-color);text-decoration:none}.post p{margin:1rem 0}.meta{margin:1.4rem 0}code,pre{background:var(--code-bg-color);margin:0 -27px;border-width:1px}code{font-family:var(--source-code-font),monospace;margin:unset;padding:0.1rem;color:var(--highlight-text-color)}pre code{background-color:unset;color:unset}pre{border-width:3px;padding:0.8rem;white-space:pre-wrap;border-style:none none none solid;border-color:var(--light-text-color)}img{max-width:100%}hr{background:var(--light-text-color);height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:0.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem 0}section{margin-top:1.5rem}blockquote{font-style:italic;border-left:5px solid var(--dark-text-color);padding-left:1rem}h1{color:var(--main-text-color);text-transform:uppercase;font-size:2rem;font-weight:bold;margin-bottom:1.5rem}h2,h3,h4,h5{font-weight:bold;margin-bottom:1.5rem;font-size:2rem}h2{font-size:1.8rem}h3{font-size:1.6rem}h4{font-size:1.4rem}h5{font-size:1.2rem}h6{font-size:1rem}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts>h3{font-weight:500}.post ul{margin:0px;margin:0px 0px 10px 10px}.post ol{margin:0px;margin:0px 0px 10px 15px}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:0.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:bold}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}time{color:var(--main-text-color)}.post>h1.title{font-size:x-large;margin-top:0;margin-bottom:0}.post>time{margin-bottom:0;margin-top:3rem}.highlight{margin:0px}main{display:flex;max-width:47rem;margin:-5rem auto 0;padding:2.4rem 2rem;flex-direction:column}.flex-row-between{display:flex;flex-direction:row;justify-content:space-between;margin-top:3rem}.social-footer{padding:1rem;display:flex;justify-content:center;position:initial}.social-footer .social-footer-icons .fa{font-size:1.3rem;color:#a9a9a9}.social-footer .social-footer-icons .fa:hover{color:dimgray;transition:color 0.3s ease-in}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}main{padding:0 2rem}}section{flex-grow:999;display:flex;flex-direction:column}figcaption{font-size:smaller}.bio{margin-bottom:1rem}::selection{background-color:#fffba0;color:#333}.search-article{position:relative}.search-article label[for="search-input"]{position:relative;top:-10px;left:11px}.search-article input[type="search"]{top:-1rem;left:0;border:0;width:100%;height:30px;outline:none;position:absolute;border-radius:5px;padding:10px 10px 10px 35px;color:var(--main-text-color);-webkit-appearance:none;background-color:rgba(128,128,128,0.1);border:1px solid rgba(128,128,128,0.1)}.search-article input[type="search"]::-webkit-input-placeholder{color:#808080}.search-article input[type="search"]::-webkit-search-decoration,.search-article input[type="search"]::-webkit-search-results-decoration{display:none}#search-results{text-align:center}#search-results li{text-align:center}#search-results li::before{content:"›";display:inline-block;margin-left:-1.3em;width:1.3em;color:var(--main-text-color)}.post-nav{display:flex;position:relative;margin-top:0;border-top:2px solid var(--light-text-color);line-height:1.4}.post-nav .post-nav-item{border-bottom:0;padding-bottom:10px;width:50%;padding-top:10px;text-decoration:none;box-sizing:border-box}.post-nav .post-nav-item .post-title{color:var(--main-text-color)}.post-nav .post-nav-item:hover .post-title,.post-nav .post-nav-item:focus .post-title{color:var(--link-color);opacity:0.9}.post-nav .post-nav-item .nav-arrow{font-size:17px;color:var(--main-text-color);margin-bottom:3px;font-weight:bold}.post-nav .post-nav-item:nth-child(odd){padding-left:0;padding-right:20px}.post-nav .post-nav-item:nth-child(even){text-align:right;padding-right:0;padding-left:20px}.tags ul{list-style:none;display:grid;grid-template-columns:auto auto auto auto auto auto;grid-template-rows:auto auto auto auto}.tags li{white-space:normal;text-overflow:ellipsis}.timeline{position:center;width:650px;margin:-6em auto;padding:1px;list-style-type:none}@media (max-width: 860px){.timeline{width:100%}}.timeline:before{position:absolute;left:50%;top:0;content:' ';display:block;width:6px;height:100%;margin-left:-3px;background:var(--light-text-color);z-index:5}@media (max-width: 375px){.timeline:before{height:150%}}.timeline li{padding:2em 0}@media (max-width: 860px){.timeline li{padding:2em 0}}.timeline li::after{content:"";display:block;height:150%;clear:both;visibility:hidden}.direction-l{position:relative;width:287px;float:left;text-align:right}@media (max-width: 860px){.direction-l{float:none;width:100%;text-align:center}}.direction-l .flag{color:#333;box-shadow:-1px 1px 1px rgba(0,0,0,0.52)}.direction-l .flag:after{content:"";position:absolute;left:100%;top:50%;height:0;width:0;margin-top:-8px;border:solid transparent;border-left-color:#f8f8f8;border-width:8px;pointer-events:none}@media (max-width: 860px){.direction-l .flag:after{content:"";position:absolute;left:50%;top:-8px;height:0;width:0;margin-left:-8px;border:solid transparent;border-bottom-color:#fff;border-width:8px;pointer-events:none}}.direction-l .time-wrapper{float:left}@media (max-width: 860px){.direction-l .time-wrapper{float:none}}.direction-r{position:relative;width:293px;float:right;text-align:left}@media (max-width: 860px){.direction-r{float:none;width:100%;text-align:center}}.direction-r .flag{color:#333;box-shadow:1px 1px 1px rgba(0,0,0,0.52)}.direction-r .flag:after{content:"";position:absolute;right:100%;top:50%;height:0;width:0;margin-top:-8px;border:solid transparent;border-right-color:#f8f8f8;border-width:8px;pointer-events:none}@media (max-width: 860px){.direction-r .flag:after{content:"";position:absolute;left:50%;top:-8px;height:0;width:0;margin-left:-8px;border:solid transparent;border-bottom-color:#fff;border-width:8px;pointer-events:none}}.direction-r .flag:before{left:-40px}.direction-r .time-wrapper{float:right}@media (max-width: 860px){.direction-r .time-wrapper{float:none}}.flag-wrapper{position:relative;display:inline-block;text-align:center}@media (max-width: 860px){.flag-wrapper{text-align:center}}.flag-wrapper .flag{position:relative;display:inline;background:#f8f8f8;padding:6px 10px;border-radius:5px;font-weight:600;text-align:left}@media (max-width: 860px){.flag-wrapper .flag{background:#fff;z-index:15}}.direction-l .flag:before,.direction-r .flag:before{position:absolute;top:60%;right:-40px;content:' ';display:block;width:12px;height:12px;margin-top:-10px;background:#fff;border-radius:10px;border:4px solid var(--link-color);z-index:10}@media (max-width: 860px){.direction-l .flag:before,.direction-r .flag:before{position:absolute;top:-30px;left:53%;content:' ';display:block;margin-left:-10px}}.time-wrapper{display:inline;line-height:1em;font-size:0.66666em;color:var(--link-color);vertical-align:middle}@media (max-width: 860px){.time-wrapper{display:block;position:relative;margin:4px 0 0 0;z-index:14}}.time-wrapper .time{display:inline-block;padding:4px 6px;background:#f8f8f8}.desc{margin:1em 0.2em -3.5em 0;font-size:0.9em;line-height:1.5em}.desc a{color:var(--link-color);text-decoration:none}.desc a:hover{text-decoration:underline}@media (max-width: 860px){.desc{position:relative;margin:1em 1em 0 1em;padding:1em;background:var(--code-bg-color);box-shadow:0 0 1px rgba(0,0,0,0.2);z-index:15}}</style><title>How to access your virtual machine from the internet with OpenVPN | robsware</title><meta name="generator" content="Jekyll v3.9.2" /><meta property="og:title" content="How to access your virtual machine from the internet with OpenVPN" /><meta name="author" content="gesko" /><meta property="og:locale" content="en_US" /><meta name="description" content="A guide on how to make a two way proxy for your VMs." /><meta property="og:description" content="A guide on how to make a two way proxy for your VMs." /><link rel="canonical" href="https://robsware.github.io//2021/06/21/openvpn" /><meta property="og:url" content="https://robsware.github.io//2021/06/21/openvpn" /><meta property="og:site_name" content="robsware" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-21T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to access your virtual machine from the internet with OpenVPN" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"gesko"},"dateModified":"2021-06-21T00:00:00+01:00","datePublished":"2021-06-21T00:00:00+01:00","description":"A guide on how to make a two way proxy for your VMs.","headline":"How to access your virtual machine from the internet with OpenVPN","mainEntityOfPage":{"@type":"WebPage","@id":"https://robsware.github.io//2021/06/21/openvpn"},"url":"https://robsware.github.io//2021/06/21/openvpn"}</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-2G53ZXRQTD"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-2G53ZXRQTD'); </script><body><main><section class="post"><div class="flex-row-between"> <a href="https://robsware.github.io//">« back</a> <button title="Change theme" id="theme-toggle" onclick="modeSwitcher()"><div></div></button></div><time datetime="2021-06-21T00:00:00+01:00">Jun 21, 2021 - 4 ' read</time><h1 class="title"> How to access your virtual machine from the internet with OpenVPN</h1><span class="meta"> <a href="https://robsware.github.io//tag/experiments">experiments</a>, <a href="https://robsware.github.io//tag/tutorials">tutorials</a>, <a href="https://robsware.github.io//tag/labs">labs</a></span><p>How to access your virtual machine from the internet with OpenVPN During my pentest engagements, I sometimes get remote code execution (RCE) on a server. Depending on the type of engagement, sometimes this might be enough for the client, but other times they might ask for post exploitation too. For cases like this, I’ve relied on a droplet (VPS) hosted on Digital Ocean to transfer files across and get my shells going. This runs into a few problems, mostly related to costs. A VPS with kali and its toolset can become somewhat expensive. My previous solution was to have a debian distro with the kali repos and just use what I need, which worked fine for the most part, but I kept wanting to have access to my full kali box on my PC. Since I started working fully remote, I like working from various places, so the option of a fixed business IP is not really feasible. Thus this project.</p><p>To achieve this goal, I’m using my Digital Ocean droplet as a proxy with openvpn. Traffic sent to the public droplet IP will be forwarded to the kali box and the responses from the kali box will be sent across the droplet as well. Since the droplet just needs to act as a proxy/VPN server, you can run it on the cheapest cloud option available as performance is not an issue. The process is surprisingly short and simple if you’re familiar with IP tables, but it still took me about a week to figure it out. So, to save you this time, here’s how you can do it too.</p><p>The Virtual Machine:</p><p>Running it in bridged mode will make management easier. If you are using VMware, just change it from the VM settings:</p><p><img src="/assets/images/openvpn1.png" alt="" /></p><p>The Router</p><p>This is fairly simple. Go to your router config, locate your kali VM, which should have its own IP since it’s a bridged network, and forward UDP port 1194:</p><p><img src="/assets/images/openvpn2.png" alt="" /></p><p>The cloud server</p><p>I used digital ocean. You can use any VPS provider you like, I liked digital ocean’s options the most so if you decide on them as well, consider using my referral link: https://m.do.co/c/ec356af64a15 .</p><p>I’ll start by rebuilding my droplet so we can have a clean state. I’ll be using a Debain 10 image:</p><p><img src="/assets/images/openvpn3.png" alt="" /></p><p>Once you get your shell on the VPS, we begin by using the amazing script made by the people at pivpn: https://www.pivpn.io/</p><pre><code class="language-code">curl -L https://install.pivpn.io | bash
</code></pre><p><img src="/assets/images/openvpn4.png" alt="" /> For interface, select eth0:</p><p><img src="/assets/images/openvpn5.png" alt="" /></p><p>You might have to create a new user for openvpn. I created a new user named “kali”.</p><p><img src="/assets/images/openvpn6.png" alt="" /></p><p>Setup a password and continue on.</p><p>We’ll be using OpenVPN for our purpose:</p><p><img src="/assets/images/openvpn7.png" alt="" /></p><p>Select no:</p><p><img src="/assets/images/openvpn8.png" alt="" /></p><p>I personally like using the google DNS server:</p><p><img src="/assets/images/openvpn9.png" alt="" /></p><p>Just keep pressing enter after this point until you get to the server reboot. Reboot when asked.</p><p>Reconnect to the box and generate an .ovpn file for your kali box:</p><pre><code class="language-code">pivpn add nopass
Enter a Name for the Client: kali
How many days should the certificate last? 1080
</code></pre><p><img src="/assets/images/openvpn10.png" alt="" /></p><p>From your kali VM, copy over the .ovpn file:</p><pre><code class="language-code">scp -i id_rsa root@138.xxx.xxx.xxx:/home/kali/ovpns/kali.ovpn .
</code></pre><p><img src="/assets/images/openvpn11.png" alt="" /></p><p>Let’s run a quick test before we move on:</p><pre><code class="language-code">sudo openvpn kali.ovpn
curl ip.me
</code></pre><p>At this point you should be seeing your droplet IP. Congratulations, you have now rolled out your own VPN service!</p><p><img src="/assets/images/openvpn12.png" alt="" /></p><p>But that’s not why we’re here. Return to the droplet/VPS, and flush the IP Tables options.</p><p>flush iptables:</p><pre><code class="language-code">iptables -F
</code></pre><p><img src="/assets/images/openvpn13.png" alt="" /></p><p>Now for the crucial part, the iptables rules that make the NAT work. In this particular case, we want to make a webserver hosted on kali on port 8000 accessible from the web:</p><pre><code class="language-code">iptables -t nat -A PREROUTING -d 138.xxx.xxx.xxx -p tcp --dport 8000 -j DNAT --to-dest 10.8.0.2:8000
iptables -t nat -A POSTROUTING -d 10.8.0.2 -p tcp --dport 8000 -j SNAT --to-source 138.xxx.xxx.1
</code></pre><p>138.xxx.xxx.xxx is the droplet IP. If you don’t have any other clients on the openvpn network, 10.8.0.2 should be your VM IP.</p><p><img src="/assets/images/openvpn14.png" alt="" /></p><p>That’s it!</p><p>You can now return to the kali box, reconnect to the .ovpn file and run a python server on port 8000:</p><p><img src="/assets/images/openvpn15.png" alt="" /></p><p>We can now visit the VPS IP and get access to our kali webserver:</p><p><img src="/assets/images/openvpn16.png" alt="" /></p><p>You can redo the above IP tables rule for any other port you want.</p><p>If you’d like to forward all ports, you can use those rules:</p><pre><code class="language-code">iptables -t nat -A PREROUTING -d 138.xxx.xxx.xxx -p tcp -j DNAT — to-dest 10.8.0.2
iptables -t nat -A POSTROUTING -d 10.8.0.2 -p tcp -j SNAT — to-source 138.xxx.xxx.1
</code></pre><p>WARNING: if you don’t have another way of managing your VPS, you will be unable to ssh into it from outside the openvpn network if you apply those rules. You can, however, SSH from inside it:</p><pre><code class="language-code">ssh -i id_rsa root@10.8.0.1
</code></pre><p>That is it. You should now have a VM accessible from the internet, with a fixed public IP. If you would like for those rules to persist across restarts, save them in /etc/iptables/rules.v4 .</p></section><section><nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/2021/01/31/mechanicus"><div class="nav-arrow">Previous</div><span class="post-title">The Mechanicus Moment</span> </a> <a class="post-nav-item post-nav-next" href="/2021/07/31/augmented"><div class="nav-arrow">Next</div><span class="post-title">The augmented human</span> </a></nav></section></main><script> function setTheme(theme) { if (theme === "dark") { document.documentElement.setAttribute('data-theme', 'dark'); window.localStorage.setItem('theme', 'dark'); document.getElementById("theme-toggle").classList.add('sun'); document.getElementById("theme-toggle").classList.remove('moon'); } else { document.documentElement.setAttribute('data-theme', 'light'); window.localStorage.setItem('theme', 'light'); document.getElementById("theme-toggle").classList.add('moon'); document.getElementById("theme-toggle").classList.remove('sun'); } } let theme = localStorage.getItem('theme'); theme = theme || (window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light' : 'light'); setTheme(theme); function modeSwitcher() { let currentMode = document.documentElement.getAttribute('data-theme'); if (currentMode === "dark") { setTheme('light'); } else { setTheme('dark'); } } </script></body><footer class="social-footer"><div class="social-footer-icons"> <a href="https://github.com/robsware" title="Github profile" target="_blank" rel="noopener noreferrer"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="https://robsware.github.io//atom.xml" title="Feed RSS" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss" aria-hidden="true"></i></a> <a href="https://github.com/robsware/robsware.github.io" title="Browse the code" target="_blank" rel="noopener noreferrer"><i class="fa fa-code" aria-hidden="true"></i></a></div></footer></html>
