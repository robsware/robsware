---
layout: page
---

<section class="post">
    <div class="flex-row-between">
    <a href="{{ site.url }}{{ site.baseurl }}/challenges/2023-03-27"> Previous challenge</a>
          <a href="{{ site.url }}{{ site.baseurl }}/"> Home</a>
      <button title="Change theme" id="theme-toggle" onclick="modeSwitcher()">
        <div></div>
      </button>
    </div>
  </section>
<p>Can you spot the vulnerability?</p>
<br>
{% highlight html %}
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintWriter;
import java.util.UUID;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;

@WebServlet("/upload")
@MultipartConfig
public class FileUploadServlet extends HttpServlet {
	
    private static final long serialVersionUID = 1L;
    private static final String UPLOAD_DIR = "uploads";
    
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    	
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        
        try {
            Part filePart = request.getPart("file");
            String fileName = getFileName(filePart);
            
            InputStream inputStream = filePart.getInputStream();
            String newFileName = UUID.randomUUID().toString() + "_" + fileName;
            writeToFile(inputStream, UPLOAD_DIR + "/" + newFileName);
            
            out.println("<h1>Success!</h1>");
            out.println("<p>Your file " + fileName + " has been uploaded as " + newFileName + ".</p>");
        } catch (Exception e) {
            out.println("<h1>Failed!</h1>");
            out.println("<p>" + e.getMessage() + "</p>");
        }
        
        out.close();
    }
    
    private String getFileName(final Part part) {
		final String partHeader = part.getHeader("content-disposition");
		for (String content : partHeader.split(";")) {
			if (content.trim().startsWith("filename")) {
				return content.substring(content.indexOf('=') + 1).trim().replace("\"", "");
			}
		}
		return null;
	}

	private void writeToFile(InputStream inputStream, String filePath) throws IOException {
		// Insecure code - does not restrict file type
		byte[] buffer = new byte[1024];
		int bytesRead = 0;
		while ((bytesRead = inputStream.read(buffer)) != -1) {
			try (FileOutputStream outputStream = new FileOutputStream(filePath, true)) {
				outputStream.write(buffer, 0, bytesRead);
			}
		}
	}
}

{% endhighlight %}{% highlight html %}
{% endhighlight %}
<br>If you did, ping me at @robsware on twitter to get a Like and a retweet. Answers will be posted next day.