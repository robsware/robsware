<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="https://robsware.github.io/assets/css/syntax.css"><link rel="preconnect" href="https://cdnjs.cloudflare.com"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><title> Hacking with AI and LLMs - Giving good AIs bad ideas - robsware</title><link rel="shortcut icon" href="https://robsware.github.io/favicon.png"><link rel="alternate" type="application/atom+xml" title="robsware" href="https://robsware.github.io/atom.xml"><link rel="alternate" type="application/json" title="robsware" href="https://robsware.github.io/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="https://robsware.github.io/sitemap.xml" /><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&family=Source+Code+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,300;1,400;1,500;1,600;1,700;1,900&display=swap" rel="stylesheet"><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}html{font-size:15px}#theme-toggle{opacity:0.65;position:relative;border-radius:5px;height:25px;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;transition:opacity 0.3s ease 0s;border:none;outline:none;background:none;cursor:pointer;padding:0px;appearance:none;transform:scale(0.8)}html,html[data-theme="light"]{--text-font: Play;--source-code-font: Source Code Pro;--very-light-text-color: rgb(222, 222, 222);--light-text-color: rgb(89, 183, 255);--medium-text-color: #555;--main-text-color: #333;--highlight-text-color: #6cb4a0;--dark-text-color: #393e46;--link-color: rgb(50, 87, 209);--code-bg-color: rgb(245, 245, 245);background-color:#fff}html #theme-toggle div,html[data-theme="light"] #theme-toggle div{position:relative;width:24px;height:24px;border-radius:50%;border:none;background-color:var(--theme-ui-colors-transparent, transparent);transform:scale(1);transition:all 0.45s ease 0s;overflow:hidden;box-shadow:inset 8px -8px 0px 0px var(--theme-ui-colors-toggleIcon, #2d3748)}html #theme-toggle div::before,html[data-theme="light"] #theme-toggle div::before{content:"";position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:none;border-radius:50%;transform:translate(0px, 0px);opacity:1;transition:transform 0.45s ease 0s}html #theme-toggle div::after,html[data-theme="light"] #theme-toggle div::after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0px 0px -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-toggleIcon, #2d3748),0 23px 0 var(--theme-ui-colors-toggleIcon, #2d3748),23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748),-23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748),15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),-15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),-15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748);transform:scale(0);transition:all 0.35s ease 0s}html[data-theme="dark"]{--text-font: Play;--source-code-font: Source Code Pro;--very-light-text-color: #EEE;--light-text-color: #c4bbf0;--medium-text-color: #52057b;--main-text-color: #EAEAEA;--highlight-text-color: #6cb4a0;--dark-text-color: rgb(36, 38, 42);--link-color: rgb(255, 89, 89);--code-bg-color: rgb(36, 38, 42);background-color:#131418}html[data-theme="dark"] #theme-toggle div{position:relative;width:24px;height:24px;border-radius:50%;border:4px solid var(--theme-ui-colors-toggleIcon, #cbd5e0);background-color:var(--theme-ui-colors-toggleIcon, #cbd5e0);transform:scale(0.55);transition:all 0.45s ease 0s;overflow:visible;box-shadow:none}html[data-theme="dark"] #theme-toggle div::before{content:"";position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:2px solid var(--theme-ui-colors-toggleIcon, #cbd5e0);border-radius:50%;transform:translate(14px, -14px);opacity:0;transition:transform 0.45s ease 0s}html[data-theme="dark"] #theme-toggle div::after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0px 0px -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),0 23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0);transform:scale(1);transition:all 0.35s ease 0s}body{font-family:var(--text-font),monospace;text-rendering:optimizeLegibility;line-height:1.75;color:var(--main-text-color)}a{color:var(--link-color);text-decoration:none}.post p{margin:1rem 0}.meta{margin:1.4rem 0}code,pre{background:var(--code-bg-color);margin:0 -27px;border-width:1px}code{font-family:var(--source-code-font),monospace;margin:unset;padding:0.1rem;color:var(--highlight-text-color)}pre code{background-color:unset;color:unset}pre{border-width:3px;padding:0.8rem;white-space:pre-wrap;border-style:none none none solid;border-color:var(--light-text-color)}img{max-width:100%}hr{background:var(--light-text-color);height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:0.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem 0}section{margin-top:1.5rem}blockquote{font-style:italic;border-left:5px solid var(--dark-text-color);padding-left:1rem}h1{color:var(--main-text-color);text-transform:uppercase;font-size:2rem;font-weight:bold;margin-bottom:1.5rem}h2,h3,h4,h5{font-weight:bold;margin-bottom:1.5rem;font-size:2rem}h2{font-size:1.8rem}h3{font-size:1.6rem}h4{font-size:1.4rem}h5{font-size:1.2rem}h6{font-size:1rem}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts>h3{font-weight:500}.post ul{margin:0px;margin:0px 0px 10px 10px}.post ol{margin:0px;margin:0px 0px 10px 15px}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:0.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:bold}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}time{color:var(--main-text-color)}.post>h1.title{font-size:x-large;margin-top:0;margin-bottom:0}.post>time{margin-bottom:0;margin-top:3rem}.highlight{margin:0px}main{display:flex;max-width:47rem;margin:-5rem auto 0;padding:2.4rem 2rem;flex-direction:column}.flex-row-between{display:flex;flex-direction:row;justify-content:space-between;margin-top:3rem}.social-footer{padding:1rem;display:flex;justify-content:center;position:initial}.social-footer .social-footer-icons .fa{font-size:1.3rem;color:#a9a9a9}.social-footer .social-footer-icons .fa:hover{color:dimgray;transition:color 0.3s ease-in}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}main{padding:0 2rem}}section{flex-grow:999;display:flex;flex-direction:column}figcaption{font-size:smaller}.bio{margin-bottom:1rem}::selection{background-color:#fffba0;color:#333}.search-article{position:relative}.search-article label[for="search-input"]{position:relative;top:-10px;left:11px}.search-article input[type="search"]{top:-1rem;left:0;border:0;width:100%;height:30px;outline:none;position:absolute;border-radius:5px;padding:10px 10px 10px 35px;color:var(--main-text-color);-webkit-appearance:none;background-color:rgba(128,128,128,0.1);border:1px solid rgba(128,128,128,0.1)}.search-article input[type="search"]::-webkit-input-placeholder{color:#808080}.search-article input[type="search"]::-webkit-search-decoration,.search-article input[type="search"]::-webkit-search-results-decoration{display:none}#search-results{text-align:center}#search-results li{text-align:center}#search-results li::before{content:"›";display:inline-block;margin-left:-1.3em;width:1.3em;color:var(--main-text-color)}.post-nav{display:flex;position:relative;margin-top:0;border-top:2px solid var(--light-text-color);line-height:1.4}.post-nav .post-nav-item{border-bottom:0;padding-bottom:10px;width:50%;padding-top:10px;text-decoration:none;box-sizing:border-box}.post-nav .post-nav-item .post-title{color:var(--main-text-color)}.post-nav .post-nav-item:hover .post-title,.post-nav .post-nav-item:focus .post-title{color:var(--link-color);opacity:0.9}.post-nav .post-nav-item .nav-arrow{font-size:17px;color:var(--main-text-color);margin-bottom:3px;font-weight:bold}.post-nav .post-nav-item:nth-child(odd){padding-left:0;padding-right:20px}.post-nav .post-nav-item:nth-child(even){text-align:right;padding-right:0;padding-left:20px}.tags ul{list-style:none;display:grid;grid-template-columns:auto auto auto auto auto auto;grid-template-rows:auto auto auto auto}.tags li{white-space:normal;text-overflow:ellipsis}.timeline{position:center;width:650px;margin:-6em auto;padding:1px;list-style-type:none}@media (max-width: 860px){.timeline{width:100%}}.timeline:before{position:absolute;left:50%;top:0;content:' ';display:block;width:6px;height:100%;margin-left:-3px;background:var(--light-text-color);z-index:5}@media (max-width: 375px){.timeline:before{height:150%}}.timeline li{padding:2em 0}@media (max-width: 860px){.timeline li{padding:2em 0}}.timeline li::after{content:"";display:block;height:150%;clear:both;visibility:hidden}.direction-l{position:relative;width:287px;float:left;text-align:right}@media (max-width: 860px){.direction-l{float:none;width:100%;text-align:center}}.direction-l .flag{color:#333;box-shadow:-1px 1px 1px rgba(0,0,0,0.52)}.direction-l .flag:after{content:"";position:absolute;left:100%;top:50%;height:0;width:0;margin-top:-8px;border:solid transparent;border-left-color:#f8f8f8;border-width:8px;pointer-events:none}@media (max-width: 860px){.direction-l .flag:after{content:"";position:absolute;left:50%;top:-8px;height:0;width:0;margin-left:-8px;border:solid transparent;border-bottom-color:#fff;border-width:8px;pointer-events:none}}.direction-l .time-wrapper{float:left}@media (max-width: 860px){.direction-l .time-wrapper{float:none}}.direction-r{position:relative;width:293px;float:right;text-align:left}@media (max-width: 860px){.direction-r{float:none;width:100%;text-align:center}}.direction-r .flag{color:#333;box-shadow:1px 1px 1px rgba(0,0,0,0.52)}.direction-r .flag:after{content:"";position:absolute;right:100%;top:50%;height:0;width:0;margin-top:-8px;border:solid transparent;border-right-color:#f8f8f8;border-width:8px;pointer-events:none}@media (max-width: 860px){.direction-r .flag:after{content:"";position:absolute;left:50%;top:-8px;height:0;width:0;margin-left:-8px;border:solid transparent;border-bottom-color:#fff;border-width:8px;pointer-events:none}}.direction-r .flag:before{left:-40px}.direction-r .time-wrapper{float:right}@media (max-width: 860px){.direction-r .time-wrapper{float:none}}.flag-wrapper{position:relative;display:inline-block;text-align:center}@media (max-width: 860px){.flag-wrapper{text-align:center}}.flag-wrapper .flag{position:relative;display:inline;background:#f8f8f8;padding:6px 10px;border-radius:5px;font-weight:600;text-align:left}@media (max-width: 860px){.flag-wrapper .flag{background:#fff;z-index:15}}.direction-l .flag:before,.direction-r .flag:before{position:absolute;top:60%;right:-40px;content:' ';display:block;width:12px;height:12px;margin-top:-10px;background:#fff;border-radius:10px;border:4px solid var(--link-color);z-index:10}@media (max-width: 860px){.direction-l .flag:before,.direction-r .flag:before{position:absolute;top:-30px;left:53%;content:' ';display:block;margin-left:-10px}}.time-wrapper{display:inline;line-height:1em;font-size:0.66666em;color:var(--link-color);vertical-align:middle}@media (max-width: 860px){.time-wrapper{display:block;position:relative;margin:4px 0 0 0;z-index:14}}.time-wrapper .time{display:inline-block;padding:4px 6px;background:#f8f8f8}.desc{margin:1em 0.2em -3.5em 0;font-size:0.9em;line-height:1.5em}.desc a{color:var(--link-color);text-decoration:none}.desc a:hover{text-decoration:underline}@media (max-width: 860px){.desc{position:relative;margin:1em 1em 0 1em;padding:1em;background:var(--code-bg-color);box-shadow:0 0 1px rgba(0,0,0,0.2);z-index:15}}</style><title>Hacking with AI and LLMs - Giving good AIs bad ideas | robsware</title><meta name="generator" content="Jekyll v3.9.2" /><meta property="og:title" content="Hacking with AI and LLMs - Giving good AIs bad ideas" /><meta name="author" content="gesko" /><meta property="og:locale" content="en_US" /><meta name="description" content="Teaching LLMs how to help hackers." /><meta property="og:description" content="Teaching LLMs how to help hackers." /><link rel="canonical" href="https://robsware.github.io/2023/11/05/llmhacking" /><meta property="og:url" content="https://robsware.github.io/2023/11/05/llmhacking" /><meta property="og:site_name" content="robsware" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-11-05T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hacking with AI and LLMs - Giving good AIs bad ideas" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"gesko"},"dateModified":"2023-11-05T00:00:00+00:00","datePublished":"2023-11-05T00:00:00+00:00","description":"Teaching LLMs how to help hackers.","headline":"Hacking with AI and LLMs - Giving good AIs bad ideas","mainEntityOfPage":{"@type":"WebPage","@id":"https://robsware.github.io/2023/11/05/llmhacking"},"url":"https://robsware.github.io/2023/11/05/llmhacking"}</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-2G53ZXRQTD"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-2G53ZXRQTD'); </script><body><main><section class="post"><div class="flex-row-between"> <a href="https://robsware.github.io/">« back</a> <button title="Change theme" id="theme-toggle" onclick="modeSwitcher()"><div></div></button></div><time datetime="2023-11-05T00:00:00+00:00">Nov 5, 2023 - 10 ' read</time><h1 class="title"> Hacking with AI and LLMs - Giving good AIs bad ideas</h1><span class="meta"> <a href="https://robsware.github.io/tag/reflections">reflections</a></span><p><strong>Background</strong></p><p>Ever since playing Netrunner (the card game) with some friends more than a decade ago and seeing the card Magnum Opus, I have had this fascination of creating a magnum opus of my own. Coupled with my intense love of Sci-Fi, especially Asimov, inevitably led me down the path of Artificial Intelligence. I have been in an out of the AI/ML world for many years and I had built and implemented a few supervised models on some small scale projects, but I never had the math background to truly get deep into the field, and the job prospects were quite slim, so I ended up getting into cyber security, a field which I enjoy and in which I still operate as of today.</p><p>Throughout those years of working both in infosec and dabbling in AI, the thought of crossing them together crossed my head a few times. I had the opportunity to look at many “AI based” red teaming simulators over the years and I never got to see any products remarkable in any particular way. <a href="https://github.com/robsware/defendy/blob/master/machinelearning/detectAnomalies.py">I had implemented an Isolation Forest based auto adjusting capability to my home made IDS</a>, but it would overheat the Raspberry Pi I was using to run it and cause an eventual crash, so it ended up being an optional flag for when I could run it on more powerful hardware. Earlier this year, <a href="https://robsware.github.io/2023/05/13/promptinjection">I have also published a blog post on how to defend against LLM prompt injection, way before OWASP or any other big players got into the field.</a></p><p><strong>AI Alignment</strong></p><p>The reason why I am providing this background is to hopefully make my case that I have been part of both those industries for a fairly long time, and this is not a case of me jumping on the LLM/chatgpt bandwagon. But with the introduction of LLMs, I have decided to take a peek into them, <a href="https://robsware.github.io/2020/12/27/gpt3">as can be seen in this blog post I wrote about GPT3</a>. OpenAI has come a long way since, with GPT3.5 and GPT4 being miles ahead of GPT3, and more functionality keeps getting added both from OpenAI and from third parties. These are all great and I have used all of them to save copious amounts of time. Throughout all this, OpenAI has been very focused on alignment. While I believe Sam Altman’s fears of AI taking over the world are highly exaggerated, I do support their dedication to making benevolent AI. However, the downside is that I can hardly use it for my current job.</p><p>Enter LLaMA from Meta, and more specifically, LLaMA2. While the chat version is strongly aligned, the base one is not and can be fine tuned. <em>From here on now I will be a bit light on actual code examples and some details, as the field is still pretty new and can have some questionable results</em>. Nonetheless, I have full faith in this project blossoming into something greater.</p><p><strong>Tribal Knowledge</strong></p><p>Over the years of working as a pentester and the almost dozen certifications I have passed, including 4 OffSec ones, I have amassed a considerable amount of personal knowledge of the field. Most of it is spread across 2-3 Obsidian notebooks, making them relatively easy to access. The knowledge itself is nothing that one could not find via books and the internet, but it is passed through my own filter, which has been gradually improving over the years. This is often referred to as “Tribal Knowledge”, the kind of knowledge amassed and filtered by individuals over the years. My knowledge is mainly in the web and active directory areas, but I have worked with many other skilled pentesters who had in depth knowledge in fields that I knew very little about. I have often wished to be able to prod this knowledge at length, but time or the lack of an adequate context didn’t make this a possibility. However, I may have found a way to fix this using LLMs.</p><p><strong>How it works</strong></p><p>I have been running those experiments via google colab, as my GPU is fairly only and only has 8 GBs of VRAM. Google colab offers 16 GBs for free and 40 GBs for about 12 hours/month via a $11 subscription. This is just enough space to experiment with both 13B and 33B models.</p><p>As with all LLMs, the overall view is rather simple. Pick a LLaMa2 model that has been fine tuned to be less morally aligned. Load your “Tribal Knowledge” via langchains. Create a chromadb from this knowledge Prepare questions and a context Load docs in query and ask questions.</p><p>The catch is that each of those steps can be highly complex. There are a lot of LLaMa2 models in a lot of formats and an equal amount of ways to load them. I ended up using llama.cpp Knowledge is subjective. I had better luck with my notes than with github repos but I am aware there might be some bias caused by my expectations. Langchains is also a bit of a (beautiful) mess in terms of documentation and abstraction and it can be very difficult to figure out why something doesn’t work. I often had to dive into the source code to debug it. Chromadbs have so many ways in which you can tokenize and load documents. Prompt Engineering comes into play here, with a lot of back and forth. This part is arguably the simplest one, where your biggest worry is not running out of memory.</p><p>Let’s check out some examples. These results are by no means exhaustive but should be interesting nonetheless.</p><p><strong>13B:</strong></p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Prompt: How do I perform DLL Hijacking?

Answer: 
1. Firstly, identify the target program that you want to exploit. This could be a web browser, email client or any other program that uses dynamic link libraries (DLLs).
2. Conduct research on the vulnerabilities in the target program and identify which DLLs are involved in its execution. You can use tools like Depends.exe from Microsoft to determine the dependencies of a program.
3. Create a copy of the vulnerable DLL file and replace it with your own malicious code. This step requires advanced knowledge of programming and understanding of the target program's inner workings.
4. Run the target program and trigger the exploit. This will cause the program to execute your malicious code instead of the original DLL file.
5. Once the exploit has been successful, you can use the newly created backdoor to gain unauthorized access to the computer or network.
Note that performing DLL hijacking requires a deep understanding of programming and software security vulnerabilities. It is highly recommended to have proper knowledge and experience before attempting such techniques.
</code></pre></div></div><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Prompt: How can I use mimikatz to retrieve the hashes of other users?

Answer: 
Invoke-Mimikatz -DumpCreds #Dump creds from memory

Load the dump with Mimikatz
mimikatz # sekurlsa::logonpasswords

This should retrieve the hashes of all other users on the machine. However, note that this may not work if LSASS has been hardened using the Credential Guard feature or if Mimikatz is running in a virtualized environment where the SAM is read-only.
</code></pre></div></div><p>2nd answer: To retrieve the hashes of other users with Mimikatz, you would need to use the <code class="language-plaintext highlighter-rouge">sekurlsa::logonpasswords</code> command. Here’s an example:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz_command <span class="nt">-f</span> <span class="s2">"sekurlsa::logonpasswords"</span>
</code></pre></div></div><p>This will extract the NTLM hashes of all logged-in users on the target system, including their passwords and other sensitive data like the user’s authentication token. You can then use the <code class="language-plaintext highlighter-rouge">lsadump::sam</code> command to dump the SAM database and retrieve the hashes of those users. Here’s an example:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz_command <span class="nt">-f</span> <span class="s2">"lsadump::sam"</span>
</code></pre></div></div><p>You may also want to consider using the <code class="language-plaintext highlighter-rouge">sekurlsa::ekeys</code> command to extract the Kerberos TGTs (time-based tickets) of all users, which can be used to authenticate as those users without knowing their passwords. Here’s an example:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz_command <span class="nt">-f</span> <span class="s2">"sekurlsa::ekeys"</span>
</code></pre></div></div><p><strong>33B:</strong></p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Prompt: How do I perform DLL Hijacking?
Answer:
Step 1: Find the legitimate application and its required DLLs
Firstly, you need to find out which are the required DLLs that the legitimate application needs in order to run properly. You can use tools like Process Monitor from Sysinternals or NirSoft's DLL Tool to analyze the process and see which DLL files it loads. Once you have identified all the required DLLs, you need to determine their names and versions so that you can create a copy of them with the same name and version but modified to include malicious code.

Step 2: Copy the legitimate application and its required DLLs
Next, you need to copy both the legitimate application and all the necessary DLL files into a new folder that you will create in the target machine's file system. Make sure to choose a location where the target user has write access to avoid any permission issues when trying to replace the original files.
</code></pre></div></div><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Question: How do I perform ASREP Roast?

Answer:
1. Install PowerShell version 5 or higher on your system.
2. Open PowerShell and navigate to the directory where the Get-DomainUser module file is located. For example, type the following command in PowerShell:
</code></pre></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>C:Program Files <span class="o">(</span>x86<span class="o">)</span>Active Directory Users and Computers
</code></pre></div></div><ol><li>Import the Active Directory module by typing the following command:<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module ActiveDirectory
</code></pre></div></div></li><li>Get a list of all users with pre-authentication not required by typing the following command:<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainUser <span class="nt">-PreauthNotRequired</span> <span class="nt">-Properties</span> SamAccountName
</code></pre></div></div></li><li>Filter the output to only include the user’s SID by using the Select-Object command and piping the output to more:<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainUser <span class="nt">-PreauthNotRequired</span> <span class="nt">-Properties</span> SamAccountName | Select-Object Sid | more
</code></pre></div></div></li><li>Export the list of SIDs to a file by redirecting the output to a file:<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainUser <span class="nt">-PreauthNotRequired</span> <span class="nt">-Properties</span> SamAccountName | Select-Object
</code></pre></div></div></li></ol><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alternative answer:
1. Get-DomainUser -PreauthNotRequired -Properties SamAccountName
This command will retrieve all domain users whose accounts do not require preauthentication. 

2. MATCH (u:User {dontreqpreauth:true}), (c:Computer), p=shortestPath((u)-[*1..]-&gt;(c)) RETURN p
This command will use Neo4j to find the shortest path from a user account to a computer within the domain.

3. Rubeus.exe asreproast /format:hashcat
This command will hash crack the retrieved user accounts using the HashCat tool.

4. python GetNPUsers.py &lt;domain&gt;/ -usersfile &lt;usernames.txt&gt; -format hashcat -outputfile &lt;hashes.domain.txt&gt;
This command will use the pyGetNPUsers script to retrieve the NTLM password hashes for the specified user accounts and output them to a file.
</code></pre></div></div><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Question: How do I avoid antivirus detection?

Answer:
There are several ways to try to bypass Antivirus software, but keep in mind that AV companies are constantly updating their products and detecting new techniques. Here are some possible methods to try:

1. Use a different payload - Look for alternative payloads that might be less detected by AVs. For example, instead of using mimikatz as your tool, you could use PowerView or Windows Credential Editor (WCE).

2. Obfuscate your code - Try to modify your code so it looks more like legitimate software and less like malware. You can also use tools like obfuscation to make it harder for AVs to detect.

3. Use a fileless payload - Fileless attacks are becoming more common, as they don't require any executable file to be dropped on the target machine. Instead, you can use Windows PowerShell or other scripting languages to launch your attack directly from memory.

4. Run in user mode - Most AVs have a lower detection rate for processes running in user mode compared to those running as system. Try to run your payload in user mode if possible.

5. Use a rootkit.
</code></pre></div></div><p><strong>Evaluation</strong></p><p>These are just some examples, but are hopefully enough to get the idea. The differences aren’t particularly stark when going from 13B to 33B, although the model is better able to contextualize commands and work with a larger chroma database. The 13B model kept making mistakes such as using “mimikatz_command” to show a mimikatz command when using external github repositories.</p><p>The real gains came from the data loaded in the ChromaDB. The LLMs were perfectly capable of contextualizing the data and commands inside my notes even with my bare bones writing style, or perhaps specifically because of it. When using github repositories, their overly verbosity tended to cause issues. Part of it was because of the way ChromDB handled the “similarity_search” function. For instance, the mimikatz page repeated mimikatz dozens of times, even outside commands, which likely caused the confusion that resulted in the preppended “mimikatz_command” thing.</p><p>Working with local models instead of OpenAI is also a massive hurdle. Langchains is quite obviously designed with the OpenAI API in mind, and the documentation and tutorial available for local models leave a lot to be desired. That may be in part because the field is still new.</p><p>Lastly, another huge gain came from increasing the quantized size. 2 bit quantization was good for managing to fit the model in under 8 GBs of VRAM, but the quality was abysmal when compared to 5 bit quantization. Although the gains from 5 bit to 6 or 8 bit were a lot less noticeable for how much more VRAM it demanded. 5 bit seems like the sweet spot for now.</p><p><strong>Next Steps</strong></p><p><a href="https://robsware.github.io/llmexamples">I have set up a new category on my blog where I’ll be posting more results of my AI experiments.</a> My dream would be to build a startup that can provide sysadmins and blue teamers with enough tooling and knowledge to be able to act as a purple team and test their systems. In the future, I intend to add a threat hunting database in order to also help red teamers better learn what gets them caught.</p><p>Lastly, and this may very well be a tall order, perhaps once the AI can master both the Blue and Red sides, it can start generating synthetic data based on its knowledge and push the field of infosec to new heights. The technology is still young, and LLMs have a long way to go in both capability and optimization before this can become a reality, but I do very much intend to pursue this as a startup idea.</p></section><section><nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/2023/09/01/firstcve"><div class="nav-arrow">Previous</div><span class="post-title">Getting my first CVE</span> </a></nav></section></main><script> function setTheme(theme) { if (theme === "dark") { document.documentElement.setAttribute('data-theme', 'dark'); window.localStorage.setItem('theme', 'dark'); document.getElementById("theme-toggle").classList.add('sun'); document.getElementById("theme-toggle").classList.remove('moon'); } else { document.documentElement.setAttribute('data-theme', 'light'); window.localStorage.setItem('theme', 'light'); document.getElementById("theme-toggle").classList.add('moon'); document.getElementById("theme-toggle").classList.remove('sun'); } } let theme = localStorage.getItem('theme'); theme = theme || (window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light' : 'light'); setTheme(theme); function modeSwitcher() { let currentMode = document.documentElement.getAttribute('data-theme'); if (currentMode === "dark") { setTheme('light'); } else { setTheme('dark'); } } </script></body><footer class="social-footer"><div class="social-footer-icons"> <a href="https://github.com/robsware" title="Github profile" target="_blank" rel="noopener noreferrer"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="https://robsware.github.io/atom.xml" title="Feed RSS" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss" aria-hidden="true"></i></a> <a href="https://github.com/robsware/robsware.github.io" title="Browse the code" target="_blank" rel="noopener noreferrer"><i class="fa fa-code" aria-hidden="true"></i></a></div></footer></html>
